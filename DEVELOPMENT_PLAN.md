# План разработки Novels

Цель: собрать многоязычную платформу для чтения новелл/манги (по референсу Remanga) с сильной экономикой (тикеты/голосование/подписка), качественным ридером (включая абзацные комментарии) и комьюнити-функциями.

Стек (из README): **Backend: Go + Chi**, **DB: PostgreSQL**, **Frontend: React**.

---

## 1) Принципы и границы MVP

### Что считаем “готово”
- Пользователь может: найти тайтл → открыть страницу тайтла → выбрать главу → читать в ридере → сохранить прогресс.
- Есть минимальный контент-цикл: админ добавляет тайтл/главы → пользователи читают.
- Мультиязычность интерфейса заложена архитектурно (i18n), даже если переводов меньше на старте.

### Что откладываем на после MVP (не блокирует запуск)
- Абзацные комментарии.
- Экономика (тикеты/голосование/подписки).
- Коллекции/вики/новости.
- Сложный антифрод (кроме базового rate-limit).

---

## 2) Архитектура (рекомендуемая)

### Репозиторий (предложение структуры)
- `backend/` — Go сервис (Chi), миграции, тесты
- `frontend/` — React приложение (SPA/SSR обсудить)
- `infra/` — Docker Compose, конфиги, CI
- `docs/` — спецификации API, схемы, ADR (архитектурные решения)

### Ключевые решения (зафиксировать до начала кодинга)
- **Аутентификация**: email+password (или OAuth позже), access/refresh (JWT) + httpOnly cookie.
- **Мультиязычность**: UI — i18n (например, JSON-словари); контент (описания/названия) — хранить переводимые поля в таблицах локализаций.
- **SEO/ЧПУ**: человекопонятные slug’и для тайтлов/глав, sitemap; если нужен сильный SEO — рассмотреть SSR (Next.js) или пререндер.
- **Хранение файлов**: обложки/медиа — локально на старте, позже S3-совместимое хранилище.
- **Время**: хранить в UTC; “дейлики” начислять по расписанию, привязанному к 00:00 UTC (и отображать 3:00 МСК, как в README).

---

## 3) Модель данных (черновой список сущностей)

### Контент
- `novels` (тайтл): slug, статус перевода, год, автор(ы), оригинальное название и т.д.
- `novel_localizations`: novel_id, lang, title, description, alt_titles
- `tags`, `genres`, `novel_tags`, `novel_genres`
- `chapters`: novel_id, number, title, published_at, price_type (free/paid опционально), text (или ссылку на источник)
- `reading_progress`: user_id, novel_id, chapter_id, position, updated_at

### Пользователи и роли
- `users`: email, password_hash, created_at, …
- `roles`/`user_roles` (гость/юзер/премиум/модер/админ) или enum + отдельные таблицы прав
- `user_profile`: avatar, bio, …

### Комьюнити
- `comments`: parent_id (nested), target_type (novel/chapter/news), target_id, body, created_at
- `comment_votes` (лайк/дизлайк), `reports`
- (позже) `paragraph_comments`: chapter_id, anchor (индекс/offset/quote), body

### Экономика (позже)
- `subscriptions`: user_id, plan, starts_at, ends_at, status
- `tickets`: user_id, type (daily_vote/novel_request/translation_ticket), balance
- `ticket_transactions`: начисление/списание, причина, reference_id
- `novel_proposals`: user_id, link, metadata, status (draft/moderation/voting/…)
- `votes`: user_id, novel_id, amount, type (daily_vote/translation_ticket/…)

---

## 4) API и модули (по этапам)

### Этап A — База платформы (MVP 1)
**Цель:** каталог + страница тайтла + ридер + минимальный профиль + админ-заливка контента.

Backend:
- Миграции Postgres, базовые таблицы контента/пользователей/прогресса.
- REST API:
  - Публичное: список тайтлов (фильтры/сортировки), карточка тайтла, список глав, получить главу.
  - Пользовательское: логин/регистрация, профиль (минимум), сохранить прогресс чтения.
  - Админское: CRUD тайтлов/глав, загрузка обложек.
- Защита: rate-limit, базовая валидация, аудит логов.

Frontend:
- Главная (скелет): блоки “Последние обновления/популярное/новинки” (можно временно из одного источника).
- Каталог + поиск (по ключевым словам).
- Страница тайтла: табы “Описание/Оглавление/Комментарии (пусто на старте)”.
- Ридер: текст главы + навигация + сохранение “последняя прочитанная”.
- Профиль (минимум): аватар/уровень заглушка/закладки заглушка.
- i18n каркас (7 языков): переключатель языка, словари.

Критерии готовности MVP 1:
- Админ добавляет тайтл и 3+ глав; пользователь читает; прогресс сохраняется.
- Каталог фильтрует/сортирует, поиск работает.
- Адаптивная верстка (mobile first), базовая темная тема.

### Этап B — Комментарии, закладки, уровни (MVP 2)
Backend:
- Закладки: списки (читаю/в планах/брошено/прочитано/любимые), сортировка по обновлениям.
- Комментарии (nested) для тайтла и главы: CRUD, лайк/дизлайк, жалобы.
- Уровни/XP: начисление XP за чтение глав/комментарии (простая формула), эндпоинты профиля.

Frontend:
- UI закладок (табы + сортировка + “Продолжить”).
- Комментарии: древовидное отображение, ответы, модерация жалоб (минимально).
- Профиль: статистика чтения, XP бар, вкладки закладок/комментариев.

Критерии готовности MVP 2:
- Пользователь ведет закладки и видит прогресс.
- Комментарии работают стабильно и модерируются.
- XP/уровни начисляются и отображаются.

### Этап C — Economy Update (тикеты/голосование/подписка)
Backend:
- Типы тикетов: Daily Vote, Novel Request, Translation Ticket (как в README).
- Начисление Daily Vote по расписанию (CRON/worker).
- Предложка тайтлов: форма → статус “на модерацию/в голосование”.
- Пул голосования: списки, сортировки, списание тикетов, защита от накрутки (лимиты, CAPTCHA при подозрениях).
- Автовыбор “победителя” раз в X часов: смена статуса/уведомления.
- Подписка: планы, статусы, выдача квот/тикетов, доступы (редактирование описания, отключение рекламы и т.п.).

Frontend:
- UI кошелька/баланса тикетов в хедере.
- Страница голосования + карточки тайтлов + действия “голосовать”.
- Предложка: форма + статус заявки.
- Подписка: экран тарифов + управление подпиской.

Критерии готовности Economy:
- Daily Vote начисляется корректно, списание и история транзакций видны.
- Предложка → голосование → победитель по таймеру работает.
- Подписка включает права (feature flags) и выдачу тикетов.

### Этап D — Community Update (коллекции/вики/новости)
Backend:
- Коллекции пользователей: CRUD, голосование за коллекции, вывод “в топ”.
- Вики-редактирование описаний: изменения через модерацию (тикет), журнал правок.
- Новости: постинг только модераторы/админы, комментарии для всех.
- Глобальная статистика + топ “потраченных билетов” за 1/7/30 дней.

Frontend:
- UI коллекций на главной + страница коллекции.
- Страница новостей + админ/модер интерфейс.
- UI “редактировать описание” (для Premium) + статус модерации.

Критерии готовности Community:
- Коллекции и голосование не ломают производительность.
- Вики-правки безопасны (модерация, аудит, откаты).
- Новости доступны и модерируются.

---

## 5) Нефункциональные требования (минимум)
- **Производительность**: пагинация каталога/комментариев, кеширование популярных списков.
- **Безопасность**: хеширование паролей (bcrypt/argon2), CSRF (если cookie), rate-limit, права доступа по ролям.
- **Надежность**: миграции, бэкапы БД, логирование, обработка ошибок.
- **Наблюдаемость**: структурные логи, метрики по запросам/ошибкам (хотя бы базово).
- **Качество**: базовые unit-тесты для критичных модулей (auth, tickets, voting).

---

## 6) Порядок реализации (приоритет)

P0 (обязательно для старта):
- Контент-цикл (админка заливки) + каталог + тайтл + ридер + прогресс.

P1 (увеличивает удержание):
- Закладки + обычные комментарии + профиль/статистика.

P2 (core-монетизация/уникальность):
- Тикеты + голосование + подписка + CRON-логика.

P3 (масштабирование комьюнити):
- Коллекции + вики + новости + абзацные комментарии.

---

## 7) Открытые вопросы (нужно подтвердить до старта)
Эти пункты уточнены:
- Контент: **новеллы** (дизайн/UX копируем с манга-сайта, ридер делаем в стиле ranobehub).
- Платность глав: **нет покупки глав/пакетов**, только **подписка** и её привилегии из README.
- SEO: **да, важен** → закладываем **SSR/пререндер**.
- Источник перевода: **пока заглушка в админке** (позже дорабатываем пайплайн).
- Daily Vote: **сгорают** (не накапливаются).
